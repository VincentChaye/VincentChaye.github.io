<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Int√©gration Mat√©riel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .error { background-color: #ffebee; border: 1px solid #f44336; color: #c62828; }
        .success { background-color: #e8f5e8; border: 1px solid #4caf50; color: #2e7d32; }
        .warning { background-color: #fff3e0; border: 1px solid #ff9800; color: #ef6c00; }
        button { margin: 5px; padding: 10px 15px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #1976d2; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; font-size: 12px; }
        .status { font-weight: bold; }
        h2 { color: #333; border-bottom: 2px solid #2196f3; padding-bottom: 5px; }
    </style>
</head>
<body>
    <h1>üßó‚Äç‚ôÇÔ∏è Test d'Int√©gration - Page Mat√©riel ZoneDeGrimpe</h1>
    
    <div class="test-section">
        <h2>1. Configuration et Connectivit√©</h2>
        <button onclick="testConfig()">Tester Configuration</button>
        <button onclick="testBackendHealth()">Tester Backend</button>
        <div id="config-results"></div>
    </div>

    <div class="test-section">
        <h2>2. Authentification</h2>
        <button onclick="testAuthEndpoints()">Tester Endpoints Auth</button>
        <button onclick="simulateLogin()">Simuler Connexion</button>
        <div id="auth-results"></div>
    </div>

    <div class="test-section">
        <h2>3. API Mat√©riel</h2>
        <button onclick="testMaterielAPI()">Tester API Mat√©riel</button>
        <button onclick="testAnalyticsAPI()">Tester Analytics</button>
        <button onclick="testAdviceAPI()">Tester Conseils</button>
        <div id="materiel-results"></div>
    </div>

    <div class="test-section">
        <h2>4. Interface Utilisateur</h2>
        <button onclick="testPageLoad()">Tester Chargement Page</button>
        <button onclick="testJSModules()">Tester Modules JS</button>
        <div id="ui-results"></div>
    </div>

    <div id="global-status" class="test-section">
        <h2>üìä R√©sum√© Global</h2>
        <div id="summary"></div>
    </div>

    <script src="./frontend/config.js"></script>
    <script>
        const API_BASE = window.APP_CONFIG?.API_URL || "http://localhost:3000";
        let testResults = {
            config: false,
            backend: false,
            auth: false,
            materiel: false,
            ui: false
        };

        function addResult(containerId, title, success, data, details = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${success ? 'success' : 'error'}`;
            div.innerHTML = `
                <div class="status">${success ? '‚úÖ' : '‚ùå'} ${title}</div>
                ${details ? `<div>${details}</div>` : ''}
                ${data ? `<pre>${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            container.appendChild(div);
            updateSummary();
        }

        function addWarning(containerId, title, message) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'result warning';
            div.innerHTML = `
                <div class="status">‚ö†Ô∏è ${title}</div>
                <div>${message}</div>
            `;
            container.appendChild(div);
        }

        function updateSummary() {
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(Boolean).length;
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <div class="result ${passed === total ? 'success' : (passed > 0 ? 'warning' : 'error')}">
                    <strong>Tests r√©ussis: ${passed}/${total}</strong>
                    <div>Configuration: ${testResults.config ? '‚úÖ' : '‚ùå'}</div>
                    <div>Backend: ${testResults.backend ? '‚úÖ' : '‚ùå'}</div>
                    <div>Authentification: ${testResults.auth ? '‚úÖ' : '‚ùå'}</div>
                    <div>API Mat√©riel: ${testResults.materiel ? '‚úÖ' : '‚ùå'}</div>
                    <div>Interface: ${testResults.ui ? '‚úÖ' : '‚ùå'}</div>
                </div>
            `;
        }

        async function testConfig() {
            try {
                const hasConfig = !!window.APP_CONFIG;
                const apiUrl = window.APP_CONFIG?.API_URL;
                
                if (!hasConfig) {
                    throw new Error('Configuration APP_CONFIG non trouv√©e');
                }
                
                testResults.config = true;
                addResult('config-results', 'Configuration', true, {
                    'APP_CONFIG pr√©sent': hasConfig,
                    'API_URL': apiUrl,
                    'URL calcul√©e': API_BASE
                });
            } catch (error) {
                testResults.config = false;
                addResult('config-results', 'Configuration', false, { error: error.message });
            }
        }

        async function testBackendHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                testResults.backend = true;
                addResult('config-results', 'Backend Health', true, data, 
                    `Backend accessible sur ${API_BASE}`);
            } catch (error) {
                testResults.backend = false;
                addResult('config-results', 'Backend Health', false, { error: error.message },
                    'V√©rifiez que le backend est d√©marr√© sur le bon port');
            }
        }

        async function testAuthEndpoints() {
            try {
                // Test endpoint register (sans donn√©es - doit retourner 400)
                const regResponse = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                // Test endpoint login (sans donn√©es - doit retourner 400)
                const loginResponse = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });

                const regOk = regResponse.status === 400; // Expected error
                const loginOk = loginResponse.status === 400; // Expected error

                if (regOk && loginOk) {
                    testResults.auth = true;
                    addResult('auth-results', 'Endpoints Auth', true, {
                        'Register endpoint': 'Accessible',
                        'Login endpoint': 'Accessible',
                        'Validation': 'Fonctionne (erreurs attendues)'
                    });
                } else {
                    throw new Error('Endpoints auth ne r√©pondent pas comme attendu');
                }
            } catch (error) {
                testResults.auth = false;
                addResult('auth-results', 'Endpoints Auth', false, { error: error.message });
            }
        }

        async function simulateLogin() {
            addWarning('auth-results', 'Simulation Login', 
                'Pour tester compl√®tement, cr√©ez un compte via register.html puis connectez-vous via login.html');
        }

        async function testMaterielAPI() {
            try {
                // Test sans authentification - doit retourner 401/403
                const response = await fetch(`${API_BASE}/api/user_materiel`);
                
                if (response.status === 401 || response.status === 403) {
                    testResults.materiel = true;
                    addResult('materiel-results', 'API Mat√©riel', true, {
                        'Endpoint': 'Accessible',
                        'S√©curit√©': 'Authentification requise (correct)',
                        'Status': response.status
                    }, 'API prot√©g√©e correctement');
                } else {
                    throw new Error(`Status inattendu: ${response.status}`);
                }
            } catch (error) {
                testResults.materiel = false;
                addResult('materiel-results', 'API Mat√©riel', false, { error: error.message });
            }
        }

        async function testAnalyticsAPI() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/gear/inspections/due?withinDays=30`);
                const isProtected = response.status === 401 || response.status === 403;
                
                addResult('materiel-results', 'API Analytics', isProtected, {
                    'Endpoint inspections': 'Accessible',
                    'Protection': isProtected ? 'Oui' : 'Non',
                    'Status': response.status
                });
            } catch (error) {
                addResult('materiel-results', 'API Analytics', false, { error: error.message });
            }
        }

        async function testAdviceAPI() {
            try {
                const response = await fetch(`${API_BASE}/api/advice/material?userId=test`);
                const isAccessible = response.status !== 404;
                
                addResult('materiel-results', 'API Conseils', isAccessible, {
                    'Endpoint conseils': 'Accessible',
                    'Status': response.status
                });
            } catch (error) {
                addResult('materiel-results', 'API Conseils', false, { error: error.message });
            }
        }

        async function testPageLoad() {
            try {
                // Test si la page mat√©riel peut √™tre charg√©e
                const response = await fetch('./frontend/materiel.html');
                const isAccessible = response.ok;
                
                if (isAccessible) {
                    testResults.ui = true;
                    addResult('ui-results', 'Page Mat√©riel', true, {
                        'HTML': 'Chargeable',
                        'Status': response.status
                    });
                } else {
                    throw new Error(`Impossible de charger materiel.html: ${response.status}`);
                }
            } catch (error) {
                testResults.ui = false;
                addResult('ui-results', 'Page Mat√©riel', false, { error: error.message });
            }
        }

        async function testJSModules() {
            try {
                // Test si les modules JS sont accessibles
                const configResponse = await fetch('./frontend/config.js');
                const materielResponse = await fetch('./frontend/js/materiel-enhanced.js');
                
                const configOk = configResponse.ok;
                const materielOk = materielResponse.ok;
                
                addResult('ui-results', 'Modules JavaScript', configOk && materielOk, {
                    'config.js': configOk ? 'OK' : 'Erreur',
                    'materiel-enhanced.js': materielOk ? 'OK' : 'Erreur'
                });
            } catch (error) {
                addResult('ui-results', 'Modules JavaScript', false, { error: error.message });
            }
        }

        // Tests automatiques au chargement
        window.onload = () => {
            console.log('üßó‚Äç‚ôÇÔ∏è D√©marrage des tests d\'int√©gration ZoneDeGrimpe');
            updateSummary();
            
            // Lancer quelques tests automatiquement
            setTimeout(() => {
                testConfig();
                setTimeout(() => testBackendHealth(), 500);
            }, 100);
        };
    </script>
</body>
</html>